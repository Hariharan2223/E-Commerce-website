{% extends 'layouts/base.html' %}
{% block title %}
Cart | ShopCart
{% endblock %}

{% block content %}
{% include 'layouts/message.html' %}
<section class="bg-light py-4 mt-5">
  <div class="container">
      <div class="row justify-content-center align-items-center">
          <div class="col-12 text-center">
              <h4 class="mb-3">Cart Items</h4>
              <hr style="border-color:#b8bfc2;">
          </div>
          {% if cart %}
          <form id="checkoutForm" method="POST" action="{% url 'checkout' %}">
              {% csrf_token %}
              <div class="table-responsive">
                  <table class="table table-bordered text-center align-middle">
                      <thead>
                          <tr>
                              
                              <th>Image</th>
                              <th>Product Name</th>
                              <th>Unit Price</th>
                              <th>Quantity</th>
                              <th>Amount</th>
                              <th>Remove</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for item in cart %}
                          <tr>
                              
                              <td >
                                  <img src="{{ item.product_image.image.url }}" height="70px" alt="{{ item.product.name }}">
                              </td>
                              <td>{{ item.product.name }}</td>
                              <td>{{ item.product.selling_price|stringformat:'d' }}</td>
                              <td>{{ item.product_qty }}</td>
                              <td class="amt">{{ item.total_cost|stringformat:'d' }}</td>
                              <td><a href="{% url 'remove_cart' item.id %}" class="btn btn-danger btn-sm remove-btn"><i class="fa fa-trash"></i> Remove</a></td>
                          </tr>
                          {% endfor %}
                          <tr>
                              <td colspan="4"><b>Total Amount</b></td>
                              <td id="net">0</td>
                              <td><button type="button" id="checkoutBtn" class="btn btn-warning">Checkout Selected Items</button></td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </form>
          {% else %}
          <div class="row">
          <div class="col-md-4"></div>
          <div class="col-md-4 text-center">
              <h1><i class="fa-solid fa-face-sad-tear" style="color: red;"></i> Sorry ! ! ! . . .</h1>
              <h3>No Cart items added</h3>
          </div>
        </div>
          {% endif %}
      </div>
  </div>
</section>


<!-- Modal HTML for Confirm Removal -->
<div class="modal fade" id="confirmRemoveModal" tabindex="-1" aria-labelledby="confirmRemoveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmRemoveModalLabel">Confirm Removal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to remove this item from cart?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a id="confirmRemoveBtn" href="#" class="btn btn-danger">Remove</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal HTML for Login Prompt -->
<div class="modal fade" id="loginPromptModal" tabindex="-1" aria-labelledby="loginPromptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginPromptModalLabel">Login Required</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You need to log in to check out products from your cart.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">Login</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const nodes = document.querySelectorAll('.amt');
    const arr = Array.from(nodes);
    const res = arr.reduce((acc, curr) => {
      return acc + Number(curr.textContent);
    }, 0);
    document.getElementById("net").innerHTML = "Rs : " + res; 

    const removeButtons = document.querySelectorAll('.remove-btn');
    const confirmRemoveBtn = document.getElementById('confirmRemoveBtn');
    const checkoutForm = document.getElementById('checkoutForm');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const isAuthenticated = "{{ user.is_authenticated|yesno:'true,false' }}" === 'true';

    removeButtons.forEach(button => {
      button.addEventListener('click', function(event) {
        event.preventDefault();
        const url = this.getAttribute('href');
        confirmRemoveBtn.setAttribute('href', url);
        $('#confirmRemoveModal').modal('show');
      });
    });

    // Reset the confirmRemoveBtn href when modal is hidden
    $('#confirmRemoveModal').on('hidden.bs.modal', function () {
      confirmRemoveBtn.setAttribute('href', '#');
    });

    checkoutBtn.addEventListener('click', function(event) {
      event.preventDefault();
      if (!isAuthenticated) {
        $('#loginPromptModal').modal('show');
      } else {
        checkoutForm.submit();
      }
    });
  });
</script>
{% endblock %}
